{
  "flow_type": "template",
  "flow_subtype": "debug",
  "flow_name": "example_calc",
  "status": "released",
  "rows": [
    {
      "type": "title",
      "name": "example_1",
      "value": "Calc JS Functions",
      "comments": "Any valid javascript syntax can be used in functions"
    },
    {
      "type": "set_variable",
      "name": "example_calc_1",
      "value": "@calc(Math.floor(Math.random()*7))",
      "comments": "Execute simple JavaScript calculation. \nGenerates a random number (0-1), multiples by 7 and rounds down"
    },
    {
      "type": "set_variable",
      "name": "example_calc_2",
      "value": "@local.example_calc_1 + 1",
      "comments": "Note - the calculation function has no knowledge of app state, and so is designed for basic javascript usage only"
    },
    {
      "type": "set_variable",
      "name": "example_calc_3",
      "value": "@calc(Math.ceil(Math.random()*3))",
      "condition": "!@local.example_calc_3",
      "comments": "This value will be randomised, but only once (if it doesn't already exist). Note as 0 is a falsy value we are rounding up (Math.ceil) to produce a number between 1 and 3"
    },
    {
      "type": "text",
      "name": "text_1",
      "value": "calc_1: @local.example_calc_1\ncalc_2: @local.example_calc_2\ncalc_3: @local.example_calc_3   (fixed)"
    },
    {
      "type": "set_variable",
      "name": "example_calc_max",
      "value": "@calc(Math.max(@local.example_calc_1,@local.example_calc_2,@local.example_calc_3))",
      "comments": "This row isn't strictly required (could all be inline), but makes authoring a bit easier"
    },
    {
      "type": "text",
      "name": "text_2",
      "value": "The largest number is: @local.example_calc_max"
    },
    {
      "type": "title",
      "name": "example_2",
      "value": "Calc Custom Functions",
      "comments": "<span>A number of custom helper functions have been written and can be directly accessed via their name and are listed in the </span><span><i>template-calc.service.ts<br/></i></span><span><i><br/></i></span><span>https://github.com/IDEMSInternational/parenting-app-ui/blob/master/src/app/shared/components/template/services/template-calc.service.ts</span>"
    },
    {
      "type": "subtitle",
      "name": "example_2.1",
      "value": "Calc Pick Random Array Item"
    },
    {
      "type": "set_variable",
      "name": "list_data",
      "value": "@data.example_calc.example_1.value_list"
    },
    {
      "type": "set_variable",
      "name": "random_item",
      "value": "@calc(pick_random(@local.list_data))",
      "comments": "Named helper functions are defined in the template-calc-service.ts file and can be used in calculations.\n(TODO - add link to the github file to see full list)\n\nThe `pick_random` function take an array and returns a random element from it"
    },
    {
      "type": "text",
      "name": "text_3",
      "value": "Random Item: @local.random_item.name"
    },
    {
      "type": "button",
      "name": "button_1",
      "value": "Randomise",
      "action_list": "click | emit:force_reprocess",
      "comments": "As dynamic variables are reprocessed every render, triggering reprocess will recalculate"
    },
    {
      "type": "subtitle",
      "name": "example_2.2",
      "value": "Calc Lookup Text"
    },
    {
      "type": "radio_group",
      "name": "selected_item",
      "action_list": "changed | emit:force_reprocess",
      "parameter_list": "answer_list: @local.list_data;",
      "comments": "As we are not saving the item to a field we still need to trigger reprocess for the text below to detect the change"
    },
    {
      "type": "set_variable",
      "name": "selected_item_text",
      "value": "@calc(lookup_answer_list(@local.list_data,@local.selected_item))",
      "comments": "The `lookup_answer_list` function can be used to extract the text from an answer_list value. \nOptionally it accepts a 3rd parameter to return another field"
    },
    {
      "type": "text",
      "name": "text_2.2a",
      "value": "Selected name: @local.selected_item",
      "condition": "@local.selected_item"
    },
    {
      "type": "text",
      "name": "text_2.2b",
      "value": "Selected text: @local.selected_item_text",
      "condition": "@local.selected_item"
    },
    {
      "type": "title",
      "name": "example_3",
      "value": "Calc Date Utilities",
      "comments": "An entire library of date utility functions are available by calling window.date_fns\nDocumentation for the utilties can be found here:\nhttps://date-fns.org/v2.23.0/docs/Getting-Started#introduction"
    },
    {
      "type": "set_variable",
      "name": "date_now",
      "value": "@calc(now())",
      "comments": "<span>A custom calc function has been added to provide shorthand method to the date constructor for the current date, i.e </span><span><b>new Date()<br/><br/></b></span><span>This will return as a date object and so can be used in further calculations</span>"
    },
    {
      "type": "text",
      "name": "text_3.1a",
      "value": "Today is @local.date_now"
    },
    {
      "type": "set_variable",
      "name": "timestamp",
      "value": "@calc(timestamp())",
      "comments": "<span>A custom calc function has been added to generate a timestamp formatted as a string in \"yyyy-MM-dd'T'HH:mm:ss\" format. By default will use current date-time, or can accept either a string or Date input, e.g. <br/><br/></span><span><b>timestamp() <br/>timestamp(dateObjectToConvert)</b></span><span><br/><br/>This does not retain timezone information but makes more compatible with html date/time pickers and easier sorting in the database (based on local time, not server timestamps)</span>"
    },
    {
      "type": "text",
      "name": "text_3.1b",
      "value": "This is a db-friendly timestamp: @local.timestamp"
    },
    {
      "type": "set_variable",
      "name": "date_formatted",
      "value": "@calc(window.date_fns.format(now(),\"dd MMM yyyy\"))",
      "comments": "https://date-fns.org/v2.23.0/docs/format"
    },
    {
      "type": "text",
      "name": "text_3.1c",
      "value": "Formatted: @local.date_formatted"
    },
    {
      "type": "set_variable",
      "name": "start_of_week",
      "value": "@calc(window.date_fns.startOfWeek(now(),{ weekStartsOn: 1 }))",
      "comments": "Calculate the start of the week assuming week starts on Monday (day 1)"
    },
    {
      "type": "set_variable",
      "name": "start_of_week_text",
      "value": "The week started on @local.start_of_week"
    },
    {
      "type": "set_variable",
      "name": "days_to_xmas",
      "value": "@calc(window.date_fns.differenceInDays(new Date(\"2021-12-25\"),now()))",
      "comments": "The output of these functions can also be tested by typing directly into the developer tools console tab on the webbrowser page with the app open"
    },
    {
      "type": "text",
      "name": "text_3.2",
      "value": "There are @local.days_to_xmas days to Christmas (2021)"
    },
    {
      "type": "set_variable",
      "name": "last_xmas_words",
      "value": "@calc(window.date_fns.formatDistance(new Date(\"2020-12-25\"),now(),{ addSuffix: true }))",
      "comments": "<span>https://date-fns.org/v2.23.0/docs/formatDistance<br/><br/></span><span>Note, more variations can be found with functions like </span><span><i>formatDistanceToNow </i></span><span>and </span><span><i>formatDuration</i></span>"
    },
    {
      "type": "text",
      "name": "text_3.3",
      "value": "The last christmas was @local.last_xmas_words"
    },
    {
      "type": "title",
      "name": "example_4",
      "value": "Calc Context Variables",
      "comments": "Specific variables are passed hardcoded to the environment/context that calculations are carried out in. \n\nAs the data can be any type (e.g. string, boolean, object, array etc.) they are stored in their native datatype and accessed via the special javascript `this` object."
    },
    {
      "name": "app_day",
      "value": "@calc(this.app_day)"
    },
    {
      "name": "app_first_launch",
      "value": "@calc(this.app_first_launch)"
    },
    {
      "name": "app_user_id",
      "value": "@calc(this.app_user_id)"
    },
    {
      "name": "device_os",
      "value": "@calc(this.device_info.operatingSystem)",
      "comments": "Device info is provided by a 3rd party plugin and contains various bits of device info. Full list available here: https://capacitorjs.com/docs/apis/device#deviceinfo"
    },
    {
      "type": "text",
      "name": "text_4.1",
      "value": "The current app day is @local.app_day"
    },
    {
      "type": "text",
      "name": "text_4.2",
      "value": "The app was first launched on @local.app_first_launch"
    },
    {
      "type": "text",
      "name": "text_4.3",
      "value": "The current user id is @local.app_user_id"
    },
    {
      "type": "text",
      "name": "text_4.4",
      "value": "The device OS is @local.device_os"
    }
  ]
}